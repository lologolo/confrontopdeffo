<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Similarity Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --bg-main: #0a0e17;
            --bg-surface: #1a1f2e;
            --bg-card: #252b3d;
            --primary: #00d4ff;
            --primary-variant: #0099cc;
            --secondary: #ffd700;
            --error: #ff6b6b;
            --success: #51cf66;
            --on-background: #ffffff;
            --on-surface: #e8eaed;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-main);
            color: var(--on-background);
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 1600px;
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            gap: 10px;
            height: 95vh;
        }

        .btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 8px 12px;
            border-radius: 24px;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background: #33ddff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        }

        .btn:disabled {
            background: #4a5568;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .btn-remove {
            background: rgba(255, 107, 107, 0.15);
            border: 2px solid var(--error);
            color: var(--error);
        }

        .btn-remove:hover {
            background: rgba(255, 107, 107, 0.25);
        }

        .btn-analyze {
            background: var(--secondary);
            color: #1a202c;
        }

        .btn-analyze:hover {
            background: #ffed4e;
        }

        /* Nuovo layout per i controlli in alto con header integrato */
        .controls-section {
            background: var(--bg-surface);
            border-radius: var(--border-radius);
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .controls-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .controls-group.flex-grow {
            flex: 1;
            min-width: 300px;
            justify-content: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            background: var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-size: 16px;
            font-weight: bold;
        }

        h1 {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary);
            margin-right: 12px;
        }

        .header-stats {
            display: flex;
            gap: 16px;
        }

        .header-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .stat-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--secondary);
        }

        .stat-label {
            color: var(--on-surface);
            font-size: 10px;
            opacity: 0.8;
        }

        #resetBtn, #exportButton {
            padding: 8px;
            width: 36px;
            height: 36px;
            justify-content: center;
        }

        .threshold-control {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 280px;
        }

        .threshold-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: var(--secondary);
            font-size: 13px;
        }

        .slider-container {
            flex: 1;
            min-width: 140px;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #4a5568;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secondary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        /* Layout principale con risultati e anteprime */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 12px;
            height: 100%;
            min-height: 0;
            overflow: hidden;
        }

        /* Sezione risultati a sinistra */
        .results-section {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .results-header {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .results-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-count {
            background: var(--primary);
            color: #000;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 16px;
            font-weight: 500;
        }

        .results-table-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .results-table-scroll {
            overflow-y: auto;
            flex: 1;
            border-radius: var(--border-radius);
            background: var(--bg-surface);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            background: var(--bg-surface);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--on-surface);
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
            background: var(--bg-surface);
            position: sticky;
            top: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th:hover {
            color: var(--primary);
        }

        tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: var(--transition);
            cursor: pointer;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        tbody tr.selected {
            background: rgba(187, 134, 252, 0.1);
        }

        td {
            padding: 8px 12px;
            position: relative;
        }

        .checkbox-cell {
            width: 16px;
            padding-right: 0;
        }

        .checkbox-cell input {
            cursor: pointer;
            width: 14px;
            height: 14px;
            accent-color: var(--primary);
        }

        .similarity-high {
            color: var(--success);
            font-weight: 500;
        }

        .similarity-medium {
            color: var(--secondary);
            font-weight: 500;
        }

        .similarity-low {
            color: var(--error);
            font-weight: 500;
        }

        .marked-for-removal {
            background: rgba(255, 107, 107, 0.1);
            color: var(--error);
            font-weight: 500;
            position: relative;
        }

        .marked-for-removal::after {
            content: 'üóëÔ∏è';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
        }

        /* Sezione anteprime a destra */
        .previews-section {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .previews-container {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 12px;
            overflow: hidden;
            min-height: 0;
        }

        .preview-box {
            background: var(--bg-surface);
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            min-height: 0;
            padding: 0;
        }

        .canvas-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
        }

        .pdf-vector-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: auto;
            background: white;
        }

        .pdf-vector-container canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 107, 107, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            opacity: 0;
            transition: var(--transition);
            pointer-events: none;
            border-radius: 4px;
            z-index: 2;
        }

        .preview-overlay.visible {
            opacity: 1;
        }

        .preview-overlay .material-icons {
            font-size: 120px;
            opacity: 0.7;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 18, 18, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: var(--on-background);
            margin-bottom: 10px;
        }

        .progress-container {
            width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--secondary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 20px 12px;
            color: var(--on-surface);
            font-size: 14px;
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 40px;
            margin-bottom: 12px;
            color: var(--primary);
            opacity: 0.5;
        }

        footer {
            text-align: center;
            padding: 16px 0;
            color: var(--on-surface);
            font-size: 14px;
            opacity: 0.7;
        }

        .similarity-indicator {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .similarity-progress {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #33ddff;
        }

        @media (max-width: 900px) {
            .container {
                padding: 15px;
                height: 95vh;
            }
            
            .controls-section {
                flex-direction: column;
                gap: 15px;
            }
            
            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .logo {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .header-stats {
                justify-content: space-around;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .threshold-control {
                flex-direction: column;
                align-items: stretch;
                min-width: auto;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
                gap: 15px;
            }
            
            .results-section, .previews-section {
                min-height: 300px;
            }
            
            .previews-container {
                flex-direction: row;
                gap: 15px;
            }
            
            .preview-box {
                min-height: 250px;
            }
            
            .preview-content {
                min-height: 200px;
            }
        }

        h2, .results-title, .previews-title { /* Aggiunto per uniformit√† */
            font-size: 20px;
            font-weight: 500;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        th[data-sort] {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-checkbox {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--secondary);
            margin-left: 8px;
        }

        .table-header-row {
            padding: 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            width: 100%;
        }

        .header-item {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            justify-content: center;
        }

        .header-item:first-child {
            justify-content: flex-start;
        }

        .header-item:last-child {
            justify-content: flex-end;
        }

        .header-checkbox {
            order: -1;
            margin-right: 6px;
        }

        .page-cell {
            padding: 8px 12px;
            position: relative;
        }

        .page-content {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .page-checkbox {
            cursor: pointer;
            width: 14px;
            height: 14px;
            accent-color: var(--primary);
        }

        .page-checkbox:checked + label {
            color: var(--error);
            font-weight: 500;
        }

        .results-table th {
            background: var(--surface-color);
            color: var(--text-color);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-table th .toggle-all {
            order: -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Nuovo Header e Controlli Integrati -->
        <div class="controls-section">
            <div class="controls-group">
                <div class="logo">
                    <div class="logo-icon"><span class="material-icons">picture_as_pdf</span></div>
                    <h1>Somiglianza Pagine PDF</h1>
                </div>
                <button id="uploadBtn" class="btn btn-outline">
                    <span class="material-icons">upload_file</span> Carica PDF
                </button>
                <input type="file" id="fileInput" accept=".pdf" style="display: none;">
            </div>

            <div class="controls-group flex-grow">
                <div class="threshold-control">
                    <label for="thresholdSlider"><span class="material-icons">tune</span> Soglia:</label>
                    <div class="slider-container">
                        <input type="range" min="1" max="100" value="85" class="slider" id="thresholdSlider">
                    </div>
                    <div class="threshold-value" id="thresholdValue">85%</div>
                </div>
            </div>
            
            <div class="controls-group">
                <div class="header-stats">
                    <div class="header-stat">
                        <div class="stat-value" id="totalPages">0</div>
                        <div class="stat-label">Pagine totali</div>
                    </div>
                    <div class="header-stat">
                        <div class="stat-value" id="duplicatePairs">0</div>
                        <div class="stat-label">Coppie simili</div>
                    </div>
                    <div class="header-stat">
                        <div class="stat-value" id="pagesToRemove">0</div>
                        <div class="stat-label">Pagine da rimuovere</div>
                    </div>
                </div>
                <button id="analyzeBtn" class="btn btn-analyze" disabled>
                    <span class="material-icons">search</span> Analizza
                </button>
                <button id="resetBtn" class="btn btn-remove" title="Ripristina">
                    <span class="material-icons">refresh</span>
                </button>
                <button id="exportButton" class="btn" disabled title="Esporta PDF">
                    <span class="material-icons">download</span>
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="results-section">
                <div class="results-header">
                    <h2 class="results-title"><span class="material-icons">list</span> Risultati</h2>
                    <div class="page-count" id="duplicateCount">0 elementi</div>
                </div>
                
                <div class="results-table-container">
                    <div class="results-table-scroll">
                        <table id="resultsTable">
                            <thead>
                                <tr>
                                    <th colspan="3" class="table-header-row">
                                        <div class="header-content">
                                            <div class="header-item">
                                                <span>Pagina 1</span>
                                                <input type="checkbox" id="selectCol1Toggle" class="header-checkbox" title="Seleziona tutta la colonna 1" disabled>
                                            </div>
                                            <div class="header-item">
                                                <span>Pagina 2</span>
                                                <input type="checkbox" id="selectCol2Toggle" class="header-checkbox" title="Seleziona tutta la colonna 2" disabled>
                                            </div>
                                            <div class="header-item">
                                                <span>Similarit√†</span>
                                            </div>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr class="empty-row">
                                    <td colspan="3">
                                        <div class="empty-state">
                                            <span class="material-icons">search</span>
                                            <div>Carica un documento e avvia l'analisi</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="previews-section">
                <div class="previews-container">
                    <div class="preview-box">
                        <div class="preview-content" id="preview1">
                            <div class="empty-state">
                                <span class="material-icons">image</span>
                                <div>Carica un documento e avvia l'analisi</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="preview-box">
                        <div class="preview-content" id="preview2">
                            <div class="empty-state">
                                <span class="material-icons">image</span>
                                <div>Carica un documento e avvia l'analisi</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">Analisi in corso...</div>
            <div id="progressText">0% completato</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Configurazione pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
        
        // Stato dell'applicazione
        const state = {
            pdfDoc: null,
            totalPages: 0,
            duplicatePairs: [],
            displayedPairs: [],
            pagesToRemove: new Set(),
            currentSelection: null,
            originalArrayBuffer: null,
            currentSort: { column: null, direction: 'asc' },
            similarityThreshold: 85
        };
        
        // Elementi DOM
        const dom = {
            fileInput: document.getElementById('fileInput'),
            uploadBtn: document.getElementById('uploadBtn'),
            exportButton: document.getElementById('exportButton'),
            resetBtn: document.getElementById('resetBtn'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            totalPages: document.getElementById('totalPages'),
            duplicatePairs: document.getElementById('duplicatePairs'),
            pagesToRemove: document.getElementById('pagesToRemove'),
            duplicateCount: document.getElementById('duplicateCount'),
            tableBody: document.getElementById('tableBody'),
            preview1: document.getElementById('preview1'),
            preview2: document.getElementById('preview2'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            thresholdSlider: document.getElementById('thresholdSlider'),
            thresholdValue: document.getElementById('thresholdValue'),
            progressText: document.getElementById('progressText'),
            progressBar: document.getElementById('progressBar'),
            selectCol1Toggle: document.getElementById('selectCol1Toggle'),
            selectCol2Toggle: document.getElementById('selectCol2Toggle')
        };
        
        // Funzioni di utilit√†
        function showLoading() {
            dom.loadingOverlay.classList.add('active');
        }
        
        function hideLoading() {
            dom.loadingOverlay.classList.remove('active');
        }
        
        function updateProgress(percent) {
            dom.progressText.textContent = `${Math.round(percent)}% completato`;
            dom.progressBar.style.width = `${percent}%`;
        }
        
        function resetUI() {
            state.pdfDoc = null;
            state.totalPages = 0;
            state.duplicatePairs = [];
            state.displayedPairs = [];
            state.pagesToRemove = new Set();
            state.currentSelection = null;
            state.originalArrayBuffer = null;
            
            dom.totalPages.textContent = '0';
            dom.duplicatePairs.textContent = '0';
            dom.pagesToRemove.textContent = '0';
            dom.duplicateCount.textContent = '0 elementi';
            dom.exportButton.disabled = true;
            dom.analyzeBtn.disabled = true;
            
            dom.tableBody.innerHTML = `
                <tr class="empty-row">
                    <td colspan="3">
                        <div class="empty-state">
                            <span class="material-icons">search</span>
                            <div>Carica un documento e avvia l'analisi</div>
                        </div>
                    </td>
                </tr>
            `;
            
            dom.preview1.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">image</span>
                    <div>Carica un documento e avvia l'analisi</div>
                </div>
            `;
            
            dom.preview2.innerHTML = `
                <div class="empty-state">
                    <span class="material-icons">image</span>
                    <div>Carica un documento e avvia l'analisi</div>
                </div>
            `;
            
            dom.selectCol1Toggle.checked = false;
            dom.selectCol1Toggle.disabled = true;
            dom.selectCol2Toggle.checked = false;
            dom.selectCol2Toggle.disabled = true;
        }
        
        // Caricamento e analisi PDF
        async function handleFileUpload(file) {
            if (!file) return;
            
            resetUI();
            showLoading();
            updateProgress(0);
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                state.originalArrayBuffer = arrayBuffer;
                
                // Carica il documento PDF
                state.pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                state.totalPages = state.pdfDoc.numPages;
                dom.totalPages.textContent = state.totalPages;
                dom.analyzeBtn.disabled = false;
                
                hideLoading();
                
            } catch (error) {
                console.error('Errore durante il caricamento del PDF:', error);
                alert('Errore durante il caricamento del PDF. Assicurati che il file sia valido.');
                hideLoading();
                resetUI();
            }
        }
        
        // Calcolo similarit√†
        function calculateSimilarity(str1, str2) {
            const normalizeText = (text) => {
                return text.toLowerCase()
                    .replace(/[^\w\s]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
            };
            
            const normStr1 = normalizeText(str1);
            const normStr2 = normalizeText(str2);
            
            if (!normStr1 && !normStr2) return 100;
            
            const tokens1 = new Set(normStr1.split(' '));
            const tokens2 = new Set(normStr2.split(' '));
            
            const intersection = new Set([...tokens1].filter(token => tokens2.has(token)));
            const union = new Set([...tokens1, ...tokens2]);
            
            return (intersection.size / union.size) * 100;
        }
        
        // Analisi pagine simili
        async function analyzeSimilarPages() {
            if (!state.pdfDoc || state.totalPages < 2) {
                alert('Il documento deve contenere almeno 2 pagine per l\'analisi');
                return;
            }
            
            showLoading();
            updateProgress(0);
            
            try {
                const pageTexts = [];
                
                for (let i = 1; i <= state.totalPages; i++) {
                    const page = await state.pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    const text = textContent.items.map(item => item.str).join(' ');
                    pageTexts.push(text);
                    
                    const progress = (i / state.totalPages) * 50;
                    updateProgress(progress);
                    
                    page.cleanup();
                }
                
                state.duplicatePairs = [];
                const threshold = state.similarityThreshold;
                const totalComparisons = (state.totalPages * (state.totalPages - 1)) / 2;
                let comparisonsDone = 0;
                
                for (let i = 0; i < state.totalPages; i++) {
                    for (let j = i + 1; j < state.totalPages; j++) {
                        const similarity = calculateSimilarity(pageTexts[i], pageTexts[j]);
                        
                        if (similarity >= threshold) {
                            state.duplicatePairs.push({
                                page1: i + 1,
                                page2: j + 1,
                                similarity: Math.round(similarity)
                            });
                        }
                        
                        comparisonsDone++;
                        const progress = 50 + (comparisonsDone / totalComparisons) * 50;
                        updateProgress(progress);
                    }
                }
                
                state.displayedPairs = [...state.duplicatePairs];
                dom.duplicatePairs.textContent = state.duplicatePairs.length;
                dom.duplicateCount.textContent = `${state.duplicatePairs.length} elementi`;
                
                updateDuplicateDisplay();
                hideLoading();
                
                dom.selectCol1Toggle.disabled = false;
                dom.selectCol2Toggle.disabled = false;
                
            } catch (error) {
                console.error('Errore durante l\'analisi:', error);
                alert('Errore durante l\'analisi del documento');
                hideLoading();
            }
        }
        
        // Aggiornamento UI
        function updateDuplicateDisplay() {
            if (state.displayedPairs.length === 0) {
                dom.tableBody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="3">
                            <div class="empty-state">
                                <span class="material-icons">check_circle</span>
                                <div>Nessuna pagina simile trovata con la soglia attuale</div>
                            </div>
                        </td>
                    </tr>
                `;
                state.currentSelection = null;
                return;
            }
            
            // Se non c'√® una selezione corrente o la selezione √® fuori range, seleziona la prima riga
            if (state.currentSelection === null || state.currentSelection >= state.displayedPairs.length) {
                state.currentSelection = 0;
            }
            
            let tableHTML = '';
            
            state.displayedPairs.forEach((pair, index) => {
                const isSelected = state.currentSelection === index ? 'selected' : '';
                const isPage1Marked = state.pagesToRemove.has(pair.page1);
                const isPage2Marked = state.pagesToRemove.has(pair.page2);
                
                let similarityClass = 'similarity-low';
                if (pair.similarity >= 90) similarityClass = 'similarity-high';
                else if (pair.similarity >= 75) similarityClass = 'similarity-medium';
                
                tableHTML += `
                    <tr class="${isSelected}" data-index="${index}">
                        <td class="page-cell">
                            <div class="page-content">
                                <input type="checkbox" id="check-${index}-1" class="page-checkbox" ${isPage1Marked ? 'checked' : ''}>
                                <label for="check-${index}-1">${pair.page1}</label>
                            </div>
                        </td>
                        <td class="page-cell">
                            <div class="page-content">
                                <input type="checkbox" id="check-${index}-2" class="page-checkbox" ${isPage2Marked ? 'checked' : ''}>
                                <label for="check-${index}-2">${pair.page2}</label>
                            </div>
                        </td>
                        <td class="${similarityClass}">
                            ${pair.similarity}%
                            <div class="similarity-indicator">
                                <div class="similarity-progress" style="width: ${pair.similarity}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            dom.tableBody.innerHTML = tableHTML;
            
            // Aggiungi event listener per i checkbox delle pagine
            document.querySelectorAll('#tableBody input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const parts = this.id.split('-');
                    const rowIndex = parseInt(parts[1]);
                    const column = parseInt(parts[2]);
                    
                    const pageNumber = column === 1 ? 
                        state.displayedPairs[rowIndex].page1 : 
                        state.displayedPairs[rowIndex].page2;
                    
                    if (this.checked) {
                        state.pagesToRemove.add(pageNumber);
                    } else {
                        state.pagesToRemove.delete(pageNumber);
                    }
                    
                    updateStatus();
                    
                    // Aggiorna immediatamente le anteprime se la riga √® selezionata
                    if (state.currentSelection === rowIndex) {
                        updatePreviews();
                    }
                });
            });
            
            // Aggiungi event listener per la selezione delle righe
            document.querySelectorAll('#tableBody tr').forEach((row, index) => {
                if (row.classList.contains('empty-row')) return;
                
                row.addEventListener('click', (e) => {
                    // Non selezionare la riga se si clicca su un checkbox
                    if (e.target.type === 'checkbox') return;
                    
                    state.currentSelection = index;
                    
                    document.querySelectorAll('#tableBody tr').forEach(tr => {
                        tr.classList.remove('selected');
                    });
                    row.classList.add('selected');
                    
                    updatePreviews();
                });
            });
            
            updateColumnToggleState();
        }
        
        // Rendering pagina PDF con supporto vettoriale
        async function renderPagePreview(pageNumber, container) {
            if (!state.pdfDoc) return null;
            
            try {
                const page = await state.pdfDoc.getPage(pageNumber);
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                // Calcola lo scale per adattarsi al contenitore
                const viewport = page.getViewport({ scale: 1 });
                const scale = Math.min(
                    containerWidth / viewport.width,
                    containerHeight / viewport.height
                );
                
                // Opzione 1: Visualizzazione vettoriale (preferita)
                if (window.pdfjsLib && window.pdfjsLib.version) {
                    // Usa PDF.js per rendering vettoriale con alta qualit√†
                    const scaledViewport = page.getViewport({ scale });
                    
                    // Crea un div per il rendering vettoriale
                    const vectorContainer = document.createElement('div');
                    vectorContainer.className = 'pdf-vector-container';
                    vectorContainer.style.width = `${scaledViewport.width}px`;
                    vectorContainer.style.height = `${scaledViewport.height}px`;
                    vectorContainer.style.position = 'relative';
                    vectorContainer.style.overflow = 'hidden';
                    vectorContainer.style.borderRadius = '4px';
                    vectorContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
                    
                    // Crea un canvas con risoluzione ultra-alta per qualit√† vettoriale
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Usa una risoluzione molto alta per simulare qualit√† vettoriale
                    const highResScale = scale * 3; // 3x per qualit√† ultra-alta
                    const highResViewport = page.getViewport({ scale: highResScale });
                    
                    canvas.width = highResViewport.width;
                    canvas.height = highResViewport.height;
                    canvas.style.width = `${scaledViewport.width}px`;
                    canvas.style.height = `${scaledViewport.height}px`;
                    
                    // Configura il contesto per rendering di alta qualit√†
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Renderizza con qualit√† ultra-alta
                    await page.render({
                        canvasContext: ctx,
                        viewport: highResViewport,
                        enableWebGL: true,
                        renderInteractiveForms: false
                    }).promise;
                    
                    vectorContainer.appendChild(canvas);
                    
                    // Crea il filtro rosso (overlay) con le stesse dimensioni
                    const overlay = document.createElement('div');
                    overlay.className = 'preview-overlay';
                    overlay.innerHTML = '<span class="material-icons">delete</span>';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.position = 'absolute';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    
                    // Imposta lo stato iniziale dell'overlay
                    const isMarked = state.pagesToRemove.has(pageNumber);
                    overlay.style.display = isMarked ? 'flex' : 'none';
                    if (isMarked) {
                        overlay.classList.add('visible');
                    }
                    
                    vectorContainer.appendChild(overlay);
                    
                    // Aggiorna il contenitore
                    container.innerHTML = '';
                    container.appendChild(vectorContainer);
                    
                    return overlay;
                } else {
                    // Fallback: rendering canvas tradizionale
                    const pixelRatio = window.devicePixelRatio || 1;
                    const renderScale = scale * Math.min(pixelRatio, 2);
                    const scaledViewport = page.getViewport({ scale: renderScale });
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;
                    canvas.style.width = `${viewport.width * scale}px`;
                    canvas.style.height = `${viewport.height * scale}px`;
                    
                    await page.render({
                        canvasContext: ctx,
                        viewport: scaledViewport
                    }).promise;
                    
                    const canvasContainer = document.createElement('div');
                    canvasContainer.className = 'canvas-container';
                    canvasContainer.style.width = `${viewport.width * scale}px`;
                    canvasContainer.style.height = `${viewport.height * scale}px`;
                    canvasContainer.style.position = 'relative';
                    canvasContainer.appendChild(canvas);
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'preview-overlay';
                    overlay.innerHTML = '<span class="material-icons">delete</span>';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.position = 'absolute';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    
                    const isMarked = state.pagesToRemove.has(pageNumber);
                    overlay.style.display = isMarked ? 'flex' : 'none';
                    if (isMarked) {
                        overlay.classList.add('visible');
                    }
                    
                    canvasContainer.appendChild(overlay);
                    
                    container.innerHTML = '';
                    container.appendChild(canvasContainer);
                    
                    return overlay;
                }
                
            } catch (error) {
                console.error('Errore nel rendering della pagina:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">error</span>
                        <div>Errore nel caricamento</div>
                    </div>
                `;
                return null;
            }
        }
        
        // Aggiornamento anteprime
        async function updatePreviews() {
            if (state.displayedPairs.length === 0) {
                dom.preview1.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">image</span>
                        <div>Carica un documento e avvia l'analisi</div>
                    </div>
                `;
                dom.preview2.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons">image</span>
                        <div>Carica un documento e avvia l'analisi</div>
                    </div>
                `;
                return;
            }
            
            // Se non c'√® una selezione corrente, mostra la prima riga di default
            if (state.currentSelection === null) {
                state.currentSelection = 0;
            }
            
            const pair = state.displayedPairs[state.currentSelection];
            
            // Forza sempre il re-rendering delle anteprime per la riga selezionata
            const overlay1 = await renderPagePreview(pair.page1, dom.preview1);
            const overlay2 = await renderPagePreview(pair.page2, dom.preview2);
            
            // Aggiorna lo stato degli overlay
            const isPage1Marked = state.pagesToRemove.has(pair.page1);
            const isPage2Marked = state.pagesToRemove.has(pair.page2);
            
            if (overlay1) {
                overlay1.style.display = isPage1Marked ? 'flex' : 'none';
                overlay1.classList.toggle('visible', isPage1Marked);
            }
            if (overlay2) {
                overlay2.style.display = isPage2Marked ? 'flex' : 'none';
                overlay2.classList.toggle('visible', isPage2Marked);
            }
        }
        
        // Selezione pagine
        function selectColumn(column) {
            const pages = state.displayedPairs.map(pair => pair[`page${column}`]);
            
            const allMarked = pages.every(page => state.pagesToRemove.has(page));
            
            if (allMarked) {
                pages.forEach(page => state.pagesToRemove.delete(page));
            } else {
                pages.forEach(page => state.pagesToRemove.add(page));
            }
            
            updateDuplicateDisplay();
            updatePreviews();
            updateStatus();
        }
        
        function updateStatus() {
            dom.pagesToRemove.textContent = state.pagesToRemove.size;
            dom.exportButton.disabled = state.pagesToRemove.size === 0;
            updateColumnToggleState();
        }
        
        function updateColumnToggleState() {
            if (state.displayedPairs.length === 0) {
                dom.selectCol1Toggle.checked = false;
                dom.selectCol2Toggle.checked = false;
                dom.selectCol1Toggle.disabled = true;
                dom.selectCol2Toggle.disabled = true;
                return;
            }

            dom.selectCol1Toggle.disabled = false;
            dom.selectCol2Toggle.disabled = false;

            const pages1 = state.displayedPairs.map(pair => pair.page1);
            const pages2 = state.displayedPairs.map(pair => pair.page2);

            dom.selectCol1Toggle.checked = pages1.every(page => state.pagesToRemove.has(page));
            dom.selectCol2Toggle.checked = pages2.every(page => state.pagesToRemove.has(page));
        }
        
        // Esportazione PDF
        async function exportPDF() {
            if (state.pagesToRemove.size === 0 || !state.originalArrayBuffer) {
                alert('Nessuna pagina selezionata per la rimozione');
                return;
            }
            
            showLoading();
            
            try {
                const pdfDoc = await PDFLib.PDFDocument.load(state.originalArrayBuffer);
                const newPdf = await PDFLib.PDFDocument.create();
                
                const pagesToKeep = [];
                for (let i = 1; i <= state.totalPages; i++) {
                    if (!state.pagesToRemove.has(i)) {
                        pagesToKeep.push(i - 1);
                    }
                }
                
                const copiedPages = await newPdf.copyPages(pdfDoc, pagesToKeep);
                copiedPages.forEach(page => newPdf.addPage(page));
                
                const pdfBytes = await newPdf.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'documento_pulito.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                hideLoading();
                
            } catch (error) {
                console.error('Errore durante l\'esportazione:', error);
                alert('Errore durante l\'esportazione del PDF');
                hideLoading();
            }
        }
        
        // Ordinamento tabella
        function sortTable(column) {
            if (state.displayedPairs.length === 0) return;
            
            const direction = state.currentSort.column === column && 
                             state.currentSort.direction === 'asc' ? 'desc' : 'asc';
            
            state.currentSort = { column, direction };
            
            state.displayedPairs.sort((a, b) => {
                const valueA = a[column];
                const valueB = b[column];
                
                if (direction === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });
            
            state.currentSelection = null;
            updateDuplicateDisplay();
            updatePreviews();
        }
        
        // Event Listeners
        dom.uploadBtn.addEventListener('click', () => dom.fileInput.click());
        
        dom.fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
        
        dom.thresholdSlider.addEventListener('input', () => {
            const value = dom.thresholdSlider.value;
            dom.thresholdValue.textContent = `${value}%`;
            state.similarityThreshold = parseInt(value);
        });
        
        dom.analyzeBtn.addEventListener('click', analyzeSimilarPages);
        dom.exportButton.addEventListener('click', exportPDF);
        dom.resetBtn.addEventListener('click', resetUI);
        
        // Selezione riga
        dom.tableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (!row || row.classList.contains('empty-row')) return;
            
            const index = parseInt(row.dataset.index);
            state.currentSelection = index;
            
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                tr.classList.remove('selected');
            });
            row.classList.add('selected');
            
            updatePreviews();
        });
        
        // Navigazione da tastiera
        document.addEventListener('keydown', (e) => {
            if (state.currentSelection === null || state.displayedPairs.length === 0) return;
            
            let newIndex = state.currentSelection;
            
            if (e.key === 'ArrowDown') {
                newIndex = Math.min(state.displayedPairs.length - 1, state.currentSelection + 1);
            } else if (e.key === 'ArrowUp') {
                newIndex = Math.max(0, state.currentSelection - 1);
            } else {
                return;
            }
            
            state.currentSelection = newIndex;
            
            document.querySelectorAll('#tableBody tr').forEach(tr => {
                tr.classList.remove('selected');
            });
            const selectedRow = document.querySelector(`#tableBody tr[data-index="${newIndex}"]`);
            if (selectedRow) {
                selectedRow.classList.add('selected');
                selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            updatePreviews();
        });
        
        // Ordinamento tabella
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                sortTable(column);
            });
        });
        
        // Toggle di selezione colonne
        dom.selectCol1Toggle.addEventListener('change', () => selectColumn(1));
        dom.selectCol2Toggle.addEventListener('change', () => selectColumn(2));
        
        // Inizializza l'app
        resetUI();
    </script>
</body>
</html>